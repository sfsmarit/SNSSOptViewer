# SNSSOptViewer

SNSSOptViewer は、最適化ツールが出力するログ（`*_state(tag).xls` / `*_char(tag).xls`）を **WinForms** で可視化するビューアです。最適化実行中でも最新ログを開けるよう、ファイルを **読み取り専用 + 共有読み取り（`FileShare.ReadWrite | FileShare.Delete`）** で開く方式に対応しています。

> ※本ツールが扱う拡張子は `.xls` ですが、実体は Excel バイナリではなく **タブ区切り/CSV 相当のテキスト** を想定しています。

---

## 特長

- **フォルダをドラッグ&ドロップ**してログフォルダを指定
- `*_state(tag).xls` と `*_char(tag).xls` を **ペアリング**して選択
- **Variable（state）**
  - `ERR0` と `T`（温度）を時系列で表示
  - 変数列を **変動率（Δ%）でランキング**、TopN をプロット
  - グラフ上ホバーで系列をハイライト
- **Goal（char）**
  - `solution+N.txt` トークンを検出し、解（Solution）を切替
  - `|` の右側にある `ERR_*`（または `(ERR_*)*係数` 形式）列を内訳として集計
  - TopN を棒グラフ + 3 分割グリッドで表示
- **最適化ツール実行中でも読み取りを試みる**
  - `File.ReadAllLines()` を避け、共有モードで読む（後述）

---

## 動作環境

- Windows
- .NET Framework（WinForms）
- Visual Studio 2017 でのビルドを想定

---

## 使い方

1. アプリを起動
2. ログが出力されるフォルダを、ウィンドウ上部バーへ **ドラッグ&ドロップ**
3. 上部のペア選択（ComboBox）で対象ログを選択
   - `*_state(tag).xls` が基準（更新日時の新しい順）
   - 対応する `*_char(tag).xls` が同一フォルダにある場合のみペアとして表示
4. タブで表示を切替
   - **Variable**: state の時系列/変数ランキング
   - **Goal**: char の目的関数内訳（solution 切替）

---

## ログ形式（想定）

### state（Variable タブ）

- 先頭行がヘッダ
- 区切り: `\t`（タブ）/ `,` / `;` / 空白（ヘッダから推定）
- 代表列:
  - `Neval`: 評価回数（X軸）
  - `ERR0`: エラー（表示では `-ERR0` を Error として描画）
  - `T`: 温度（任意、右軸）
- 変数列は、`Neval` の右隣〜 `|` の直前までを対象

### char（Goal タブ）

- 先頭行がヘッダ
- ヘッダ内に `|` が存在し、**最後の `|` より右側**を ERR 列候補とみなす
- 解の識別は、各行の右端付近に現れる `solution+N.txt`（N は整数）トークン
- ERR 列の名称は以下を想定:
  - `ERR_xxx` → `xxx` を表示名
  - `(ERR_xxx)*...` → `xxx` を表示名
  - `(xxx)*...` → `xxx` を表示名（括弧がある場合）

---

## 最適化実行中に「開けない」問題への対応

最適化ツールがログを開いたまま書き込みを続けていると、ビューア側の読み込みが失敗することがあります。

本ツールでは、以下の方法で「読める限り読む」挙動にしています。

- `FileStream` を `FileAccess.Read`（読み取り専用）で開く
- `FileShare.ReadWrite | FileShare.Delete` を指定して **書き込み側と共有**
- タイミング依存の失敗に備え、短い待ちを挟んで **数回リトライ**
- 書き込み途中で最終行が壊れている場合があるため、**末尾の不完全行を破棄**

> 注意: 書き込み側が `FileShare.None` などで完全排他している場合は、共有読み取りでも開けません。その場合は「コピーして読む」「スナップショットを取る」等の別対策が必要です。

---

## ビルド方法

1. Visual Studio 2017 でソリューションを開く
2. `SNSSOptViewer` プロジェクトをビルド
3. `bin\Debug` または `bin\Release` の exe を実行

---

## 既知の制約 / Tips

- `.xls` でも **Excel ブック**として読み込むわけではありません（テキスト想定）
- ファイルが更新中の瞬間は、途中までしか読めない（/列数不一致で行をスキップする）場合があります
- `Goal` タブで解（solution）が見つからない場合は、ログに `solution+N.txt` が含まれているか確認してください
